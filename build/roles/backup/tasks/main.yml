---

#Snapshot backup entire EC2 instance
- name: Create a directory to store backup scripts
  file: path={{ virtualenv_path }}/aws-backups
        owner={{ application_user }}
        mode=0700
        state=directory
  tags: backup

- name: Get a copy of aws-snapshot-tool script
  get_url: url=https://github.com/evannuil/aws-snapshot-tool/raw/master/makesnapshots.py 
           dest={{ virtualenv_path }}/aws-backups
           owner={{ application_user }}
           mode=0700
  tags: backup

- name: Create aws-snapshot-tool template
  template: src=config.j2
            dest={{ virtualenv_path }}/aws-backups/config.py
            owner={{ application_user }}
            group={{ gunicorn_group }}
            mode=0400
            backup=yes
  tags: backup

- name: Add makesnapshots to daily cron job
  cron: name='Daily Backup' user={{ application_user }} minute='0' hour='1' job='{{ virtualenv_path }}/aws-backups/makesnapshots.py day'
  tags: backup

- name: Add weekly makesnapshots to cron
  cron: name='Weekly Backup' user={{ application_user }} minute='0' hour='1' weekday='6' job='{{ virtualenv_path }}/aws-backups/makesnapshots.py week'
  tags: backup

- name: Add monthly makesnapshots to cron
  cron: name='Monthly Backup' user={{ application_user }} minute='0' hour='1' day='1' job='{{ virtualenv_path }}/aws-backups/makesnapshots.py month'
  tags: backup